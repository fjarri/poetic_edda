%!TEX TS-program = xelatex
%!TEX encoding = UTF-8 Unicode

\documentclass{scrbook}

\usepackage{xltxtra}
\usepackage{polyglossia}
\usepackage{epigraph}
\usepackage{fancyhdr}
\usepackage{boolexpr}
\usepackage{setspace}
\usepackage{tocloft}
\usepackage{typearea}
\usepackage{perpage}
\usepackage{fontspec}
\usepackage{xunicode}
\usepackage{verbatim} 
\usepackage{color}
\usepackage{microtype}
\usepackage{multirow}
\usepackage{longtable}


% ======================================================================
% macro for switching between draft/release modes
\newcounter{draftcounter}
\newcommand{\isDraft}{\boolexpr{\value{draftcounter} = 1}}
\newcommand{\DraftMode}{\setcounter{draftcounter}{1}}

% ======================================================================
% some macro machinery for readability of conditions

\newcounter{bookformatcounter}

\newcommand{\definebookformat}[1]{
	\newcounter{#1}
	\stepcounter{bookformatcounter}
	\setcounter{#1}{\value{bookformatcounter}}
}

\newcommand{\setbookformat}[1]{
	\newcounter{bookformat}
	\setcounter{bookformat}{\value{#1}}
}

\newcommand{\isAFourOneside}{\boolexpr{\value{bookformat} = \value{bfAFourOneside}}}
\newcommand{\isAFourTwoside}{\boolexpr{\value{bookformat} = \value{bfAFourTwoside}}}
\newcommand{\isAFour}{\boolexpr{\isAFourOneside \OR \isAFourTwoside}}

\newcommand{\isIPad}{\boolexpr{\value{bookformat} = \value{bfIPad}}}

\newcommand{\isSevenInches}{\boolexpr{\value{bookformat} = \value{bfSevenInches}}}

% ======================================================================
% select mode here
\DraftMode

% ======================================================================
% select book format here

% available formats
\definebookformat{bfAFourOneside} % A4, one side (for reading on screen)
\definebookformat{bfAFourTwoside} % A4, two sides (for printing)
\definebookformat{bfIPad} % 9.7'' screen, 3x4, 11pt font, portrait
\definebookformat{bfSevenInches} % 7'' screen, 3x4, 11pt font, portrait

\setbookformat{bfAFourOneside}


% ======================================================================
% Size-dependent definitions
% ======================================================================

\switch
\case{\isAFour}
	\ifcase\isAFourOneside
		\usepackage[a4paper, twoside=false]{geometry}
	\else
		\usepackage[a4paper, twoside=true]{geometry}
	\fi
	\KOMAoptions{headings=big, fontsize=12pt}
	\KOMAoptions{headinclude=true, DIV=15}
	\newcommand{\tocnumwidth}{5em}
	\newcommand{\tocspacing}{1.0} % ToC almost fits 2 pages, we need to help it a bit
	\newcommand{\tocmarginwidth}{2.55em} % left indent for non-first lines of ToC
	\newcommand{\titlesize}{48pt}
	\setlength{\parindent}{1.5em}
\case{\isIPad}
	\usepackage[papersize={5.82in,7.76in}, twoside=false]{geometry}
	\areaset{5.5in}{7.44in} % using the whole screen, IPad already has "physical" margin
	\KOMAoptions{headings=normal, fontsize=11pt}
	\KOMAoptions{headinclude=true}
	\newcommand{\tocnumwidth}{5em}
	\newcommand{\tocspacing}{0.9} % ToC almost fits 2 pages, we need to help it a bit
	\newcommand{\tocmarginwidth}{2.55em} % left indent for non-first lines of ToC
	\setlength{\parindent}{1em}
\case{\isSevenInches}
	\usepackage[papersize={4.8in,5.6in}, twoside=false]{geometry}
	\areaset{4.5in}{5.4in} % using the whole screen, readers have "physical" margin
	\KOMAoptions{headings=normal, fontsize=11pt}
	\KOMAoptions{headinclude=true}
	\newcommand{\tocnumwidth}{5em}
	\newcommand{\tocspacing}{0.9}
	\newcommand{\tocmarginwidth}{2.55em} % left indent for non-first lines of ToC
	\setlength{\parindent}{1em}
\endswitch
\recalctypearea


% ======================================================================
% Size-independent definitions
% ======================================================================

\setmainfont[Mapping=tex-text]{Charis SIL}
\setsansfont[Mapping=tex-text]{Lucida Grande}

\newfontfamily\numberfont[Mapping=tex-text]{Optima}
\newfontfamily\commentfont[Mapping=tex-text]{Charis SIL}
\newfontfamily\stanzafont[Mapping=tex-text]{Gentium Plus}

\newfontfamily\vidir[Mapping=tex-text]{Vidir}

\DeclareMicrotypeSet*[protrusion]{mainset}{ family={rm*} }

\setmainlanguage{english}
\setotherlanguage{icelandic}
\pagestyle{fancy} % enable fancy headers

% FIXME: probably more accurate tuning is needed
% but this values do not produce overfull hboxes, so they are good enough for a start
% (otherwise I would have to wrap single paragraphs in \sloppy...\fussy)

% tolerance for paragraph badness
\tolerance = 1000

% if two first passes fail and this value is nonzero, TeX will perform the third pass, using additional whitespace
\emergencystretch = 20pt	

% prefer uneven page borders and constant distance between paragraphs
\raggedbottom

\MakePerPage{footnote} % reset footnote counter on each page

% try not to allow cases when last paragraph line starts a new page or when first paragraph line ends a page
\widowpenalty=1300
\clubpenalty=1300

% proper hyphenation for complex words
\XeTeXinterchartokenstate=1
\XeTeXcharclass `\- 24
\XeTeXinterchartoks 24 0 = {\hskip\z@skip}
\XeTeXinterchartoks 0 24 = {\nobreak}

\newcommand{\mdash}{---}
\newcommand{\ndash}{--}
\newcommand{\sdash}{---} % dash for the beginning of speech (babel uses "--* for it)
\newcommand{\enummdash}{---} % mdash for enumerations
\newcommand{\commamdash}{---} % mdash after comma


% ======================================================================
% Macros
% ======================================================================


% ======================================================================
% Labels and references

% initial declaration for variable which will keep current chapter label
\newcommand{\eddachapterlabel}{Stub value, should not see it}

% stanza label
\newcommand{\eddastanzalabel}[1]{
	\phantomsection
	\label{\eddachapterlabel:#1}
}

% No spaces in these macros, because TeX considers them to be significant

\ifcase\isDraft
	\newcommand{\eddachapterref}[1]{\textcolor{red}{\emph{#1}}}
	\newcommand{\eddastanzaref}[2][\@empty]{\textcolor{red}{#2}}
\else
	\newcommand{\eddachapterref}[1]{\hyperref[cha:#1]{\emph{#1}}}
	\newcommand{\eddastanzaref}[2][\@empty]{\ifx\@empty#1\hyperref[\eddachapterlabel:#2]{#2}\else\hyperref[cha:#1:#2]{#2}\fi}
\fi

\newcommand{\eddastanzarangeref}[3][\@empty]{\eddastanzaref[#1]{#2}\ndash\eddastanzaref[#1]{#3}}
\newcommand{\eddacombinedref}[2]{\eddachapterref{#1,} \eddastanzaref[#1]{#2}}
\newcommand{\eddacombinedrangeref}[3]{\eddachapterref{#1,} \eddastanzarangeref[#1]{#2}{#3}}


% ======================================================================
% Chapter macro
\newcommand{\eddachapter}[3]{
	\addchap[#1 (#3)]{#1}
	\vskip -\baselineskip
	{\Large\sffamily #3}
	\vskip 2\baselineskip
	\renewcommand{\eddachapterlabel}{cha:#2}
	\label{\eddachapterlabel}

	% Additional label variants
	% Rationale:
	% 1. I want labels to appear in text in italic.
	% 2. Punctuation near italic text must be italic too.
	% 3. \hyperref does not support complex macros (I tired to use xstring to cut punctuation from labels) as labels
	%     (probably one has to explicitly evaluate them somehow, but I did not manage to do that).
	% 4. I want to hide all complexity in macros (and writing something like \chapterref{Voluspo}{,} is just ugly).
	% Therefore it seems like the simplest solution.
	\label{\eddachapterlabel.}
	\label{\eddachapterlabel,}
	\label{\eddachapterlabel:}
	\label{\eddachapterlabel;}
}


% ======================================================================
% Stanza macros

% in case you want to change the way stanza number is displayed
\newcommand{\eddastanzanum}[1]{{\numberfont\Large\textbf{#1.}}}

% stanza separators for half-lines
\definecolor{gray}{cmyk}{0,0,0,0.5}
\newcommand{\eddainlinesep}{\textcolor{gray}{~|~}} % for inline quoting
\newcommand{\eddastanzasep}{\textcolor{gray}{~|}

\hspace{1.5em}}

\newcommand{\sep}{\eddainlinesep} % inline separator by default

% mark lacuna in stanza
\newcommand{\eddalacuna}{. . .}

% separator line
\newcommand{\eddasepline}{
	\begin{center}
	\rule[1ex]{.5\textwidth}{.5pt}
	\end{center}
}

% dagger (used by Gering and Hildebrand)
\newcommand{\eddadagger}{$\dagger$}

% For quoting stanzas in comments
\newcommand{\eddainlinestanza}[1]{
	{\stanzafont
		\begin{verse}
		#1
		\end{verse}
	}
}

% main stanza font
\newcommand{\eddastanzatexticelandic}[1]{\texticelandic{\stanzafont #1}}
\newcommand{\eddastanzatextenglish}[1]{\textenglish{\stanzafont #1}}

\newcommand{\eddanumberfield}[1]{\makebox[2\parindent][l]{\eddastanzanum{#1}}}
\newcommand{\eddaleftfield}[1]{\begin{minipage}[t]{0.4\textwidth} \texticelandic{\stanzafont #1} \end{minipage}}
\newcommand{\eddarightfield}[1]{\begin{minipage}[t]{0.5\textwidth} \textenglish{\stanzafont #1} \end{minipage}}
\newcommand{\eddastanzatable}[1]{
	{\renewcommand{\sep}{\eddastanzasep}
	\large\setstretch{1.3}
		\begin{longtable}{@{} p{2\parindent} @{} p{0.4\textwidth} @{} p{0.5\textwidth}}
		#1
		\end{longtable}
	}
}

% base command for stanza pair
\newcommand{\eddastanza}[3][\@empty]{

	\eddastanzalabel{#2}
	\nopagebreak

	% stanza pair
	\eddastanzatable{#3}

	% comment
	\ifx\@empty#1
	\else
		\nopagebreak
		{\commentfont\noindent#1}
	\fi
	\nopagebreak
	\vskip 0.5\baselineskip
}


% ======================================================================
% Document parameters

\title{\fontsize{\titlesize}{\titlesize}\selectfont Poetic Edda}
\subtitle{Old Norse--English diglot}

%\author{
%Original text from ``Die Lieder der älteren Edda'' \\
%by Karl Hildebrand and Hugo Gering, \\
%translation and comments by \\
%Henry Adams Bellows
%}

\author{
Old Norse: Karl Hildebrand and Hugo Gering, \\
English: Henry Adams Bellows
}

\date{}
\publishers{\small{Typeset by Bogdan Opanchuk, \\ compiled on \today \\ Melbourne, Australia}}

% Pdf converter settings
\usepackage{cmap}
\usepackage[bookmarks, bookmarkstype=toc, pdfborder={0 0 0}, pdfa=true]{hyperref}
\hypersetup{pdftitle={Poetic Edda}}


% ======================================================================
% Main document 
% ======================================================================
\begin{document}

% cover
\extratitle{
\begin{center}

{\vidir\fontsize{\titlesize}{\titlesize}\selectfont Poetic Edda }
\singlespacing
{\Large\vidir Old Norse-English diglot}
\vskip 3\baselineskip
\includegraphics[width=0.8\textwidth]{coverimage.eps}

\end{center}
}

% title
\maketitle

\frontmatter

\clearpage
\begingroup

	% Disable page numbers
	\pagestyle{empty}
	\renewcommand*{\chapterpagestyle}{empty}
	\tocloftpagestyle{empty} % due to tocloft package, ToC is not affected by common page style

	\renewcommand{\@pnumwidth}{\tocnumwidth}
	\renewcommand{\@tocrmarg}{\tocmarginwidth plus1fil} % make ToC flushed to the left

	\begin{spacing}{\tocspacing}
	\tableofcontents
	\end{spacing}

\clearpage
\endgroup

\mainmatter

% ascii -> gering (bellows)
% a` -> á (ā)
% A` -> Á (Ā)
% e` -> é (ē)
% e:: -> ë
% E` -> Ē
% o` -> ó (ō)
% O` -> Ó (Ō)
% y` -> ý (ȳ)
% u` -> ú (ū)
% i` -> í (ī)
% i:: -> ï
% I` -> Í (Ī)
% o/ -> ø (ö) - I use ø
% o/` -> ǿ (ő) - I use ø̄
% O/ -> Ø (Ö) - I use Ø
% O/` -> Ǿ (Ő) - I use Ø̄
% o~ -> ǫ
% o~` -> ǫ́ (ǭ)
% O~ -> Ǫ
% O~` -> Ǫ́ (Ǭ)
% a_e -> æ
% æ` -> ǽ (ǣ)
% a_e` -> ǽ (ǣ)

% Ø̄ǬŌĀĪ āēōȳūø̄īǭǣ ïë ø Ø ǫ Ǫ æ þÞ

\include{build/introduction}
\include{build/voluspo}
\include{build/hovamol}
\include{build/vafthruthnismol}
\include{build/pronounciation}

\end{document}